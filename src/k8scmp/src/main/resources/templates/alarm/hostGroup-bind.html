<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head th:include="/public/commonframe :: cssScript" />
	<body>
		<div id="common-header">
			<div th:include="/public/commonframe :: app-header"></div>
		</div>
		<div id="content">
			<div id="content-header">
				<h2>添加主机</h2>
			</div>
			<div id="breadcrumb">
				<a href="#" class="current tip-bottom" title="添加主机">添加主机</a>
			</div>
			
			<div class="container-fluid">
				<div class="row-fluid" >
					<div class="span12">
						<div class="widget-box">
							<table width="100%" height="100%">
							  <tr> 
							    <td width="30%" valign="top">
							    	<div>
							    	<!-- <div class="controls">
							    		<br/>
										&nbsp;&nbsp;&nbsp;&nbsp;选择集群&nbsp;<select name="labelName" id="labelName" style="width: 65px;">	
											<option th:each="label:${labelList}" th:value="${label.labelName}" 	
											th:text="${label.labelName}" ></option>
										</select>
									</div> -->
									<br/>
							    	&nbsp;&nbsp;&nbsp;&nbsp;<span>选择主机</span>
							    	&nbsp;&nbsp;&nbsp;&nbsp;<i style="font-size: 10px">勾选要添加的主机之后可在所选主机列表中查看。</i>
							    	<br/>
							    	<br/>
							    	<br/>
							    	<table class="table">
							    		<thead>
							    			<tr>
							    				<td>
							    					<div style="text-align: center;width: 40px">
							    						<input type="checkbox"/>
							    					</div>
							    				</td>
							    				<td>
							    					<div style="text-align: center;width: 80px" data-field="hostname">
							    						主机
							    					</div>
							    				</td>
							    				<td>
							    					<div style="text-align: center;width: 80px" data-field="hostip">
							    						IP
							    					</div>
							    				</td>
							    			</tr>
							    		</thead>
							    		<tbody id="hosttbody">
							    			<tr th:each="host,hostStat:${nodeList}" id="hosttr">
							    				<td>&nbsp;&nbsp;<input type="checkbox" id="hostchecked" name="eCheck" th:onclick="'checkedtable2table(\''+${hostGroupId}+'\',\''+${host.id}+'\')'"/></td>
							    				<td th:text="${host.hostname}" name="hostname"></td>
							    				<td th:text="${host.ip}" name="hostip"></td>
							    			</tr> 
							    		</tbody>
							    	</table>
							    	<br/><br/><br/>
							    	</div>
							    </td>
							    <td style="border-left:#cccccc 5px solid;" width="55%" valign="top">
							    	<div>
							    	<br/>
								    	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>所选主机</span>
								    	&nbsp;&nbsp;&nbsp;&nbsp;<i style="font-size: 10px">展示上一步勾选的所有主机。</i>
								    	<br/>
								    	<br/>
								    	<table class="table">
								    		<thead>
								    			<tr>
								    				<td width="120px">
								    					<div style="text-align: center;width: 80px">
								    						主机
								    					</div>
								    				</td>
								    				<td width="120px">
								    					<div style="text-align: center;width: 60px">
								    						IP
								    					</div>
								    				</td>
								    				<td width="120px">
								    					<div style="text-align: center;width: 70px">
								    						创建时间
								    					</div>
								    				</td>
								    				<td width="120px">
								    					<div style="text-align: center;width: 30px">
								    						操作
								    					</div>
								    				</td>
								    			</tr>
								    		</thead>
								    		<tbody id="bindtbody">
								    			<tr  th:each="bind,bindStat:${bindList}">
								    				<td name="bindName" th:text="${bind.hostname}"></td>
								    				<td name="bindIp" th:text="${bind.ip}"></td>
								    				<td th:text="${bind.createTime}"></td>
								    				<td><a th:onclick="'javascript:$(this).parent().parent().remove();unBinding(\''+${hostGroupId}+'\',\''+${bind.id}+'\',\''+${bind.ip}+'\',\''+1+'\')'">解除</a></td>
							    				</tr>
								    		</tbody>
								    	</table>
								    		
								    	
								    	<br/><br/><br/>
								    	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a th:href="@{/alarm}" class="btn tip-bottom">返回</a>
								    	<input type="submit" value="提交" th:onclick="'putBinding(\''+${hostGroupId}+'\')'" class="btn btn-primary"></input>
							    	</div>
							    </td>
							  </tr>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="common-footer">
				<div th:include="/public/commonframe::app-footer"></div>
			</div>
		</div>	
		<div th:include="/public/commonframe::jsScript(activeMenuNumber=43)" ></div>
		
		<script type="text/javascript">
			$(document).ready(function(){
				//
				//先进行判断两个table中是否含有相同的主机，相同就将checked 不可选
				$("#bindtbody").find("tr").each(function(){
					var bindName = $(this).find('[name="bindName"]').text();
					$("input[name='eCheck']").each(function(){
						var $tr = $(this).parent().parent().parent().parent().parent().parent();
						var hostName = $tr.find('[name="hostname"]').text();
						if(hostName == bindName){
							$(this).parent().attr("class","checked");
							$(this).parent().parent().parent().attr("class","checked");
							$(this).attr("checked",true);
							$(this).prop("disabled",true);
						}
					})
				})
			})
			
			/* function getHostList(labeList,hostGroupId){
				var hostInfo = labeList.hostInfo
				var labName = $("#labelName option:selected").val();
				for(var i in labeList){
					var labelName = labelList[i].labelName;
					if(labelName == labName){
						$tr = '<tr id="hosttr">'
		    				+'<td>&nbsp;&nbsp;<input type="checkbox" id="hostchecked" name="eCheck" onclick="checkedtable2table('+hostGroupId+')"/></td>'
		    				+'<td th:text="'+t.hostname+'" name="hostname"></td>'
		    				+'<td th:text="'+t.ip+'" name="hostip"></td>'
		    				+'</tr>';
						$("#hosttbody").append($tr);
				}
				
				$.each(labeList,function(i,v){
					
					if(v.labelName == labelName){
						$.each(hostInfo,function(n,t){
							
						})
						
					}
					
				}) 
			} */
		
			function checkedtable2table(hostGroupId){
				$("input[name='eCheck']").each(function(i,v){
					var $trId = "tr"+i;
					if($(this).attr("checked")){
						var $tr = $(this).parent().parent().parent().parent().parent().parent();
						var hostname = $tr.find('[name="hostname"]').text();
						var hostip= $tr.find('[name="hostip"]').text();
						var date = new Date('2017-10-19 09:39:23');
						var tr = '<tr id="'+$trId+'"><td>'+hostname+'</td><td>'+hostip+'</td><td>'+date.toLocaleString() +'</td><td><a onclick="javascript:$(this).parent().parent().remove();unChecked(\''+hostip+'\');">解除</a></td></tr>';
						$("#bindtbody").append(tr);
					}else{
						var id = "#"+$trId;
						$(id).remove();
					}
				});
			}	
			
			function unChecked(ip){
				$("input[name='eCheck']").each(function(){
					if($(this).attr("checked")){
						var $td = $(this).parent().parent().parent().parent().parent().parent();
						var hostip= $td.find('[name="hostip"]').text();
						var hostIp = ip;
						if(hostip == ip){
							$(this).parent().removeAttr("class");
							$(this).parent().parent().parent().removeAttr("class");
						}
					}
				})
			}
			
			function unBinding(id,hostId,ip,isSend){
				$("input[name='eCheck']").each(function(){
					if($(this).attr("checked")){
						var $td = $(this).parent().parent().parent().parent().parent().parent();
						var hostip= $td.find('[name="hostip"]').text();
						if(hostip == ip){
							$(this).parent().removeAttr("class");
							$(this).parent().parent().parent().removeAttr("class");
							$(this).prop("disabled",false);
						}
					}
				})
				if(isSend == "1"){
					$.ajax({
						url:"/hostgroup/bind/"+id+"/"+hostId,
						type:"delete"
					});
				}
				
			}
			
			
			
			function putBinding(id){
				var hostInfoList = new Array();
				$("#bindtbody").children("tr").each(function(){
					//alert("1");
					var arr = []
					$(this).children('td').each(function(i,v){
						//alert($(this).text());
						arr.push($(this).text());
					})
					var hostInfo = new Object();
					hostInfo.hostname = arr[0];
					hostInfo.ip = arr[1];
					hostInfoList.push(hostInfo);
				})
				
				$.ajax({
					url:"/hostgroup/bind/"+id,
					data:JSON.stringify(hostInfoList),
					type:"post",
					dataType: "json",
					contentType : 'application/json;charset=utf-8',
					success:function(data){
						location.reload();
					}
				})
			}
		
		
		</script>
	</body>
</html>
